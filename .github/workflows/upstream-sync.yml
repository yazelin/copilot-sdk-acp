name: Upstream Sync

on:
  schedule:
    # ÊØèÂ§© UTC 23:00ÔºàÂè∞ÁÅ£ÊôÇÈñì 07:00Ôºâ
    - cron: "0 23 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (‰∏çÂª∫Á´ã PRÔºåÂè™È°ØÁ§∫Â∑ÆÁï∞)"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/github/copilot-sdk.git || true
          git fetch upstream main

      - name: Check for new commits
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          LOCAL_SHA=$(git merge-base HEAD upstream/main)

          if [ "$UPSTREAM_SHA" = "$LOCAL_SHA" ]; then
            echo "already_up_to_date=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Already up to date with upstream"
          else
            COMMIT_COUNT=$(git rev-list --count "$LOCAL_SHA".."$UPSTREAM_SHA")
            COMMIT_LOG=$(git log --oneline "$LOCAL_SHA".."$UPSTREAM_SHA" | head -20)
            echo "already_up_to_date=false" >> "$GITHUB_OUTPUT"
            echo "commit_count=$COMMIT_COUNT" >> "$GITHUB_OUTPUT"
            echo "upstream_sha=$UPSTREAM_SHA" >> "$GITHUB_OUTPUT"
            echo "base_sha=$LOCAL_SHA" >> "$GITHUB_OUTPUT"

            # Store commit log for PR body (multiline)
            {
              echo "commit_log<<EOF"
              echo "$COMMIT_LOG"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"

            echo "üì¶ Found $COMMIT_COUNT new upstream commits"
          fi

      - name: Attempt merge
        if: steps.check.outputs.already_up_to_date != 'true'
        id: merge
        run: |
          BRANCH="upstream-sync/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          # Attempt merge (allow conflicts)
          if git merge upstream/main --no-commit --no-ff 2>/dev/null; then
            echo "merge_conflicts=false" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Merge completed without conflicts"
          else
            echo "merge_conflicts=true" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è Merge has conflicts, attempting auto-resolve..."

            # === Ëá™Âãï‰øùÁïôÊàëÂÄëÁöÑ ACP Ê™îÊ°à ===
            ACP_RESOLVED=false
            for path in nodejs/src/protocols/ nodejs/test/protocols/ nodejs/test/e2e/acp.test.ts; do
              if git diff --name-only --diff-filter=U | grep -q "^${path}"; then
                echo "  ‰øùÁïô ours: $path"
                git checkout --ours -- "$path" 2>/dev/null || true
                git add "$path" 2>/dev/null || true
                ACP_RESOLVED=true
              fi
            done

            if [ "$ACP_RESOLVED" = "true" ]; then
              echo "acp_auto_resolved=true" >> "$GITHUB_OUTPUT"
            else
              echo "acp_auto_resolved=false" >> "$GITHUB_OUTPUT"
            fi

            # === Ê™¢Êü•Ê†∏ÂøÉÊ™îÊ°àË°ùÁ™ÅÔºàÈúÄË¶ÅÊâãÂãïËôïÁêÜÔºâ===
            MANUAL_REVIEW=false
            CONFLICT_FILES=""
            for path in nodejs/src/client.ts nodejs/src/types.ts; do
              if git diff --name-only --diff-filter=U | grep -q "^${path}"; then
                echo "  ‚ùå Ê†∏ÂøÉÊ™îÊ°àË°ùÁ™Å: $path"
                MANUAL_REVIEW=true
                CONFLICT_FILES="$CONFLICT_FILES $path"
              fi
            done

            echo "needs_manual_review=$MANUAL_REVIEW" >> "$GITHUB_OUTPUT"
            echo "conflict_files=$CONFLICT_FILES" >> "$GITHUB_OUTPUT"

            # Â¶ÇÊûúÈÇÑÊúâÊú™Ëß£Ê±∫ÁöÑË°ùÁ™ÅÔºåÊ™¢Êü•ÊòØÂê¶ÈÉΩÂú®ÂèØËá™ÂãïËß£Ê±∫ÁöÑË∑ØÂæë‰∏≠
            REMAINING=$(git diff --name-only --diff-filter=U 2>/dev/null || true)
            if [ -n "$REMAINING" ]; then
              echo "  Ââ©È§òÊú™Ëß£Ê±∫ÁöÑË°ùÁ™Å:"
              echo "$REMAINING"
              if [ "$MANUAL_REVIEW" = "false" ]; then
                # ÈùûÊ†∏ÂøÉÊ™îÊ°àÁöÑË°ùÁ™ÅÔºå‰πüÊ®ôË®òÁÇ∫ÈúÄË¶ÅÊâãÂãïËôïÁêÜ
                echo "needs_manual_review=true" >> "$GITHUB_OUTPUT"
                echo "conflict_files=$REMAINING" >> "$GITHUB_OUTPUT"
              fi
            fi
          fi

      - name: Commit and push
        if: steps.check.outputs.already_up_to_date != 'true' && steps.merge.outputs.needs_manual_review != 'true'
        run: |
          # Check if there are changes to commit
          if git diff --cached --quiet && git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: sync upstream main (${{ steps.check.outputs.commit_count }} commits)

          Upstream: github/copilot-sdk@${{ steps.check.outputs.upstream_sha }}
          ACP auto-resolved: ${{ steps.merge.outputs.acp_auto_resolved || 'false' }}"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üèÉ Dry run ‚Äî skipping push"
            git log --oneline -5
          else
            git push origin "${{ steps.merge.outputs.branch }}"
            # Wait for GitHub to index the new branch
            sleep 30
          fi

      - name: Commit conflict state for manual review
        if: steps.check.outputs.already_up_to_date != 'true' && steps.merge.outputs.needs_manual_review == 'true'
        run: |
          # Â∞çË°ùÁ™ÅÊ™îÊ°à‰øùÁïô ours ÁâàÊú¨‰ª•‰æø pushÔºàPR ‰∏≠ÊúÉÊ®ôÁ§∫ÈúÄË¶ÅÊâãÂãïËôïÁêÜÔºâ
          git checkout --ours -- . 2>/dev/null || true
          git add -A

          git commit -m "chore: sync upstream main (conflicts need manual review)

          Upstream: github/copilot-sdk@${{ steps.check.outputs.upstream_sha }}
          Conflicting files: ${{ steps.merge.outputs.conflict_files }}

          ‚ö†Ô∏è This PR has unresolved conflicts that need manual review."

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üèÉ Dry run ‚Äî skipping push"
          else
            git push origin "${{ steps.merge.outputs.branch }}"
            sleep 30
          fi

      - name: Create PR (clean merge)
        if: steps.check.outputs.already_up_to_date != 'true' && steps.merge.outputs.needs_manual_review != 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          BODY=$(cat <<'HEREDOC'
          ## Upstream Sync

          **Commits:** ${{ steps.check.outputs.commit_count }} new commits from upstream
          **Upstream SHA:** `${{ steps.check.outputs.upstream_sha }}`
          **Base SHA:** `${{ steps.check.outputs.base_sha }}`

          ### Upstream Changes
          ```
          ${{ steps.check.outputs.commit_log }}
          ```

          ### Conflict Resolution
          - ACP paths auto-resolved: ${{ steps.merge.outputs.acp_auto_resolved || 'none' }}
          - Manual review needed: none

          ### After Merge
          ```bash
          # Rebase feature branches
          git fetch origin main
          git rebase origin/main
          ```

          ---
          Auto-generated by upstream-sync workflow
          HEREDOC
          )

          # Use REST API instead of GraphQL to avoid shallow clone issues
          gh api repos/${{ github.repository }}/pulls \
            -f base=main \
            -f head="${{ steps.merge.outputs.branch }}" \
            -f title="chore: sync upstream (${{ steps.check.outputs.commit_count }} commits)" \
            -f body="$BODY"

      - name: Create PR (needs manual review)
        if: steps.check.outputs.already_up_to_date != 'true' && steps.merge.outputs.needs_manual_review == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          BODY=$(cat <<'HEREDOC'
          ## Upstream Sync ‚Äî Needs Manual Review

          **Commits:** ${{ steps.check.outputs.commit_count }} new commits from upstream
          **Upstream SHA:** `${{ steps.check.outputs.upstream_sha }}`
          **Base SHA:** `${{ steps.check.outputs.base_sha }}`

          ### Upstream Changes
          ```
          ${{ steps.check.outputs.commit_log }}
          ```

          ### Conflicting Files (need manual resolution)
          ```
          ${{ steps.merge.outputs.conflict_files }}
          ```

          These core files have conflicts between upstream changes and our modifications.
          Please resolve manually:

          ```bash
          # Fetch and attempt merge locally
          git fetch upstream main
          git checkout main
          git merge upstream/main

          # Resolve conflicts in:
          ${{ steps.merge.outputs.conflict_files }}

          # Then commit and push
          git add -A
          git commit
          git push
          ```

          ### ACP Paths
          - ACP auto-resolved: ${{ steps.merge.outputs.acp_auto_resolved || 'false' }}

          ---
          Auto-generated by upstream-sync workflow
          HEREDOC
          )

          gh api repos/${{ github.repository }}/pulls \
            -f base=main \
            -f head="${{ steps.merge.outputs.branch }}" \
            -f title="chore: sync upstream (needs manual review)" \
            -f body="$BODY"
